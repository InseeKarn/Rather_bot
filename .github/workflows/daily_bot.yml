name: Riddle Shorts Upload

on:
  schedule:
    - cron: "0 15 * * *"  
  workflow_dispatch:  

jobs:
  run-bot:
    runs-on: ubuntu-latest

    env:
      YT_API: ${{ secrets.YT_API }}
      YT_PRIVACY: ${{ secrets.YT_PRIVACY }}
      YT_CATEGORY: ${{ secrets.YT_CATEGORY }}
      DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
      HAS_CRED: ${{ secrets.YT_CREDENTIALS != '' }}
      HAS_TOKEN: ${{ secrets.TOKEN_JSON != '' }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Install ImageMagick
      run: |
        sudo apt-get update
        sudo apt-get install -y imagemagick
        sudo sed -i 's|rights="none"|rights="read|write"|g' /etc/ImageMagick-6/policy.xml
    
    - name: Create empty state files if missing
      run: |
        [ -f token.json ] || echo "{}" > token.json

    - name: Create credentials.json
      if: ${{ env.HAS_CRED }}
      run: printf '%s' '${{ secrets.YT_CREDENTIALS }}' > credentials.json

      # ✅ Validate JSON
    - name: Validate JSON files
      run: |
        python -m json.tool credentials.json > /dev/null
        python -m json.tool token.json > /dev/null


    # ✅ Save state
    - name: Save initial state files
      uses: actions/upload-artifact@v4
      with:
        name: state-files
        path: |
            token.json
            credentials.json

    - name: Run main.py
      run: python main.py
